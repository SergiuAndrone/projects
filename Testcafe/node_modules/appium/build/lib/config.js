"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getBuildInfo = getBuildInfo;
exports.validateServerArgs = validateServerArgs;
exports.checkNodeOk = checkNodeOk;
exports.showConfig = showConfig;
exports.warnNodeDeprecations = warnNodeDeprecations;
exports.validateTmpDir = validateTmpDir;
exports.getNonDefaultArgs = getNonDefaultArgs;
exports.getDeprecatedArgs = getDeprecatedArgs;
exports.getGitRev = getGitRev;
exports.checkValidPort = checkValidPort;
exports.updateBuildInfo = updateBuildInfo;
exports.APPIUM_VER = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _axios = _interopRequireDefault(require("axios"));

var _teen_process = require("teen_process");

var _utils = require("./utils");

var _logger = _interopRequireDefault(require("./logger"));

var _semver = _interopRequireDefault(require("semver"));

var _argsparseActions = require("./argsparse-actions");

const npmPackage = require(_path.default.resolve(_utils.rootDir, 'package.json'));

const APPIUM_VER = npmPackage.version;
exports.APPIUM_VER = APPIUM_VER;
const MIN_NODE_VERSION = npmPackage.engines.node;
const GIT_META_ROOT = '.git';
const GIT_BINARY = `git${_appiumSupport.system.isWindows() ? '.exe' : ''}`;
const GITHUB_API = 'https://api.github.com/repos/appium/appium';
const BUILD_INFO = {
  version: APPIUM_VER
};

function getNodeVersion() {
  return _semver.default.coerce(process.version);
}

function isSubClass(candidateClass, superClass) {
  return _lodash.default.isFunction(superClass) && _lodash.default.isFunction(candidateClass) && (candidateClass.prototype instanceof superClass || candidateClass === superClass);
}

async function updateBuildInfo(useGithubApiFallback = false) {
  const sha = await getGitRev(useGithubApiFallback);

  if (!sha) {
    return;
  }

  BUILD_INFO['git-sha'] = sha;
  const built = await getGitTimestamp(sha, useGithubApiFallback);

  if (!_lodash.default.isEmpty(built)) {
    BUILD_INFO.built = built;
  }
}

async function getGitRev(useGithubApiFallback = false) {
  if (await _appiumSupport.fs.exists(_path.default.resolve(_utils.rootDir, GIT_META_ROOT))) {
    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(GIT_BINARY, ['rev-parse', 'HEAD'], {
        cwd: _utils.rootDir
      });
      return stdout.trim();
    } catch (ign) {}
  }

  if (!useGithubApiFallback) {
    return null;
  }

  try {
    const resBodyObj = (await _axios.default.get(`${GITHUB_API}/tags`, {
      headers: {
        'User-Agent': `Appium ${APPIUM_VER}`
      }
    })).data;

    if (_lodash.default.isArray(resBodyObj)) {
      for (const {
        name,
        commit
      } of resBodyObj) {
        if (name === `v${APPIUM_VER}` && commit && commit.sha) {
          return commit.sha;
        }
      }
    }
  } catch (ign) {}

  return null;
}

async function getGitTimestamp(commitSha, useGithubApiFallback = false) {
  if (await _appiumSupport.fs.exists(_path.default.resolve(_utils.rootDir, GIT_META_ROOT))) {
    try {
      const {
        stdout
      } = await (0, _teen_process.exec)(GIT_BINARY, ['show', '-s', '--format=%ci', commitSha], {
        cwd: _utils.rootDir
      });
      return stdout.trim();
    } catch (ign) {}
  }

  if (!useGithubApiFallback) {
    return null;
  }

  try {
    const resBodyObj = (await _axios.default.get(`${GITHUB_API}/commits/${commitSha}`, {
      headers: {
        'User-Agent': `Appium ${APPIUM_VER}`
      }
    })).data;

    if (resBodyObj && resBodyObj.commit) {
      if (resBodyObj.commit.committer && resBodyObj.commit.committer.date) {
        return resBodyObj.commit.committer.date;
      }

      if (resBodyObj.commit.author && resBodyObj.commit.author.date) {
        return resBodyObj.commit.author.date;
      }
    }
  } catch (ign) {}

  return null;
}

function getBuildInfo() {
  return BUILD_INFO;
}

function checkNodeOk() {
  const version = getNodeVersion();

  if (!_semver.default.satisfies(version, MIN_NODE_VERSION)) {
    _logger.default.errorAndThrow(`Node version must be ${MIN_NODE_VERSION}. Currently ${version.version}`);
  }
}

function warnNodeDeprecations() {}

async function showConfig() {
  await updateBuildInfo(true);
  console.log(JSON.stringify(getBuildInfo()));
}

function getNonDefaultArgs(parser, args) {
  return parser.rawArgs.reduce((acc, [, {
    dest,
    default: defaultValue
  }]) => {
    if (args[dest] && args[dest] !== defaultValue) {
      acc[dest] = args[dest];
    }

    return acc;
  }, {});
}

function getDeprecatedArgs(parser, args) {
  return parser.rawArgs.reduce((acc, [[name], {
    dest,
    default: defaultValue,
    action
  }]) => {
    if (!args[dest] || args[dest] === defaultValue) {
      return acc;
    }

    if (action === null || action === void 0 ? void 0 : action.deprecated_for) {
      acc[name] = action.deprecated_for;
    } else if (isSubClass(action, _argsparseActions.StoreDeprecatedDefaultCapabilityAction)) {
      acc[name] = _argsparseActions.DEFAULT_CAPS_ARG;
    }

    return acc;
  }, {});
}

function checkValidPort(port, portName) {
  if (port > 0 && port < 65536) return true;

  _logger.default.error(`Port '${portName}' must be greater than 0 and less than 65536. Currently ${port}`);

  return false;
}

function validateServerArgs(parser, args) {
  let exclusives = [['noReset', 'fullReset'], ['ipa', 'safari'], ['app', 'safari'], ['forceIphone', 'forceIpad'], ['deviceName', 'defaultDevice']];

  for (let exSet of exclusives) {
    let numFoundInArgs = 0;

    for (let opt of exSet) {
      if (_lodash.default.has(args, opt) && args[opt]) {
        numFoundInArgs++;
      }
    }

    if (numFoundInArgs > 1) {
      throw new Error(`You can't pass in more than one argument from the ` + `set ${JSON.stringify(exSet)}, since they are ` + `mutually exclusive`);
    }
  }

  const validations = {
    port: checkValidPort,
    callbackPort: checkValidPort,
    bootstrapPort: checkValidPort,
    chromedriverPort: checkValidPort,
    robotPort: checkValidPort,
    backendRetries: r => r >= 0
  };
  const nonDefaultArgs = getNonDefaultArgs(parser, args);

  for (let [arg, validator] of _lodash.default.toPairs(validations)) {
    if (_lodash.default.has(nonDefaultArgs, arg)) {
      if (!validator(args[arg], arg)) {
        throw new Error(`Invalid argument for param ${arg}: ${args[arg]}`);
      }
    }
  }
}

async function validateTmpDir(tmpDir) {
  try {
    await (0, _appiumSupport.mkdirp)(tmpDir);
  } catch (e) {
    throw new Error(`We could not ensure that the temp dir you specified ` + `(${tmpDir}) exists. Please make sure it's writeable.`);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb25maWcuanMiXSwibmFtZXMiOlsibnBtUGFja2FnZSIsInJlcXVpcmUiLCJwYXRoIiwicmVzb2x2ZSIsInJvb3REaXIiLCJBUFBJVU1fVkVSIiwidmVyc2lvbiIsIk1JTl9OT0RFX1ZFUlNJT04iLCJlbmdpbmVzIiwibm9kZSIsIkdJVF9NRVRBX1JPT1QiLCJHSVRfQklOQVJZIiwic3lzdGVtIiwiaXNXaW5kb3dzIiwiR0lUSFVCX0FQSSIsIkJVSUxEX0lORk8iLCJnZXROb2RlVmVyc2lvbiIsInNlbXZlciIsImNvZXJjZSIsInByb2Nlc3MiLCJpc1N1YkNsYXNzIiwiY2FuZGlkYXRlQ2xhc3MiLCJzdXBlckNsYXNzIiwiXyIsImlzRnVuY3Rpb24iLCJwcm90b3R5cGUiLCJ1cGRhdGVCdWlsZEluZm8iLCJ1c2VHaXRodWJBcGlGYWxsYmFjayIsInNoYSIsImdldEdpdFJldiIsImJ1aWx0IiwiZ2V0R2l0VGltZXN0YW1wIiwiaXNFbXB0eSIsImZzIiwiZXhpc3RzIiwic3Rkb3V0IiwiY3dkIiwidHJpbSIsImlnbiIsInJlc0JvZHlPYmoiLCJheGlvcyIsImdldCIsImhlYWRlcnMiLCJkYXRhIiwiaXNBcnJheSIsIm5hbWUiLCJjb21taXQiLCJjb21taXRTaGEiLCJjb21taXR0ZXIiLCJkYXRlIiwiYXV0aG9yIiwiZ2V0QnVpbGRJbmZvIiwiY2hlY2tOb2RlT2siLCJzYXRpc2ZpZXMiLCJsb2dnZXIiLCJlcnJvckFuZFRocm93Iiwid2Fybk5vZGVEZXByZWNhdGlvbnMiLCJzaG93Q29uZmlnIiwiY29uc29sZSIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJnZXROb25EZWZhdWx0QXJncyIsInBhcnNlciIsImFyZ3MiLCJyYXdBcmdzIiwicmVkdWNlIiwiYWNjIiwiZGVzdCIsImRlZmF1bHQiLCJkZWZhdWx0VmFsdWUiLCJnZXREZXByZWNhdGVkQXJncyIsImFjdGlvbiIsImRlcHJlY2F0ZWRfZm9yIiwiU3RvcmVEZXByZWNhdGVkRGVmYXVsdENhcGFiaWxpdHlBY3Rpb24iLCJERUZBVUxUX0NBUFNfQVJHIiwiY2hlY2tWYWxpZFBvcnQiLCJwb3J0IiwicG9ydE5hbWUiLCJlcnJvciIsInZhbGlkYXRlU2VydmVyQXJncyIsImV4Y2x1c2l2ZXMiLCJleFNldCIsIm51bUZvdW5kSW5BcmdzIiwib3B0IiwiaGFzIiwiRXJyb3IiLCJ2YWxpZGF0aW9ucyIsImNhbGxiYWNrUG9ydCIsImJvb3RzdHJhcFBvcnQiLCJjaHJvbWVkcml2ZXJQb3J0Iiwicm9ib3RQb3J0IiwiYmFja2VuZFJldHJpZXMiLCJyIiwibm9uRGVmYXVsdEFyZ3MiLCJhcmciLCJ2YWxpZGF0b3IiLCJ0b1BhaXJzIiwidmFsaWRhdGVUbXBEaXIiLCJ0bXBEaXIiLCJlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBS0EsTUFBTUEsVUFBVSxHQUFHQyxPQUFPLENBQUNDLGNBQUtDLE9BQUwsQ0FBYUMsY0FBYixFQUFzQixjQUF0QixDQUFELENBQTFCOztBQUNBLE1BQU1DLFVBQVUsR0FBR0wsVUFBVSxDQUFDTSxPQUE5Qjs7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBR1AsVUFBVSxDQUFDUSxPQUFYLENBQW1CQyxJQUE1QztBQUVBLE1BQU1DLGFBQWEsR0FBRyxNQUF0QjtBQUNBLE1BQU1DLFVBQVUsR0FBSSxNQUFLQyxzQkFBT0MsU0FBUCxLQUFxQixNQUFyQixHQUE4QixFQUFHLEVBQTFEO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLDRDQUFuQjtBQUVBLE1BQU1DLFVBQVUsR0FBRztBQUNqQlQsRUFBQUEsT0FBTyxFQUFFRDtBQURRLENBQW5COztBQUlBLFNBQVNXLGNBQVQsR0FBMkI7QUFDekIsU0FBT0MsZ0JBQU9DLE1BQVAsQ0FBY0MsT0FBTyxDQUFDYixPQUF0QixDQUFQO0FBQ0Q7O0FBRUQsU0FBU2MsVUFBVCxDQUFxQkMsY0FBckIsRUFBcUNDLFVBQXJDLEVBQWlEO0FB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cm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBta2RpcnAsIGZzLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyByb290RGlyIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCB7XG4gIFN0b3JlRGVwcmVjYXRlZERlZmF1bHRDYXBhYmlsaXR5QWN0aW9uLCBERUZBVUxUX0NBUFNfQVJHLFxufSBmcm9tICcuL2FyZ3NwYXJzZS1hY3Rpb25zJztcblxuXG5jb25zdCBucG1QYWNrYWdlID0gcmVxdWlyZShwYXRoLnJlc29sdmUocm9vdERpciwgJ3BhY2thZ2UuanNvbicpKTtcbmNvbnN0IEFQUElVTV9WRVIgPSBucG1QYWNrYWdlLnZlcnNpb247XG5jb25zdCBNSU5fTk9ERV9WRVJTSU9OID0gbnBtUGFja2FnZS5lbmdpbmVzLm5vZGU7XG5cbmNvbnN0IEdJVF9NRVRBX1JPT1QgPSAnLmdpdCc7XG5jb25zdCBHSVRfQklOQVJZID0gYGdpdCR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YDtcbmNvbnN0IEdJVEhVQl9BUEkgPSAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy9hcHBpdW0vYXBwaXVtJztcblxuY29uc3QgQlVJTERfSU5GTyA9IHtcbiAgdmVyc2lvbjogQVBQSVVNX1ZFUixcbn07XG5cbmZ1bmN0aW9uIGdldE5vZGVWZXJzaW9uICgpIHtcbiAgcmV0dXJuIHNlbXZlci5jb2VyY2UocHJvY2Vzcy52ZXJzaW9uKTtcbn1cblxuZnVuY3Rpb24gaXNTdWJDbGFzcyAoY2FuZGlkYXRlQ2xhc3MsIHN1cGVyQ2xhc3MpIHtcbiAgcmV0dXJuIF8uaXNGdW5jdGlvbihzdXBlckNsYXNzKSAmJiBfLmlzRnVuY3Rpb24oY2FuZGlkYXRlQ2xhc3MpXG4gICAgJiYgKGNhbmRpZGF0ZUNsYXNzLnByb3RvdHlwZSBpbnN0YW5jZW9mIHN1cGVyQ2xhc3MgfHwgY2FuZGlkYXRlQ2xhc3MgPT09IHN1cGVyQ2xhc3MpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVCdWlsZEluZm8gKHVzZUdpdGh1YkFwaUZhbGxiYWNrID0gZmFsc2UpIHtcbiAgY29uc3Qgc2hhID0gYXdhaXQgZ2V0R2l0UmV2KHVzZUdpdGh1YkFwaUZhbGxiYWNrKTtcbiAgaWYgKCFzaGEpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgQlVJTERfSU5GT1snZ2l0LXNoYSddID0gc2hhO1xuICBjb25zdCBidWlsdCA9IGF3YWl0IGdldEdpdFRpbWVzdGFtcChzaGEsIHVzZUdpdGh1YkFwaUZhbGxiYWNrKTtcbiAgaWYgKCFfLmlzRW1wdHkoYnVpbHQpKSB7XG4gICAgQlVJTERfSU5GTy5idWlsdCA9IGJ1aWx0O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEdpdFJldiAodXNlR2l0aHViQXBpRmFsbGJhY2sgPSBmYWxzZSkge1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZShyb290RGlyLCBHSVRfTUVUQV9ST09UKSkpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKEdJVF9CSU5BUlksIFsncmV2LXBhcnNlJywgJ0hFQUQnXSwge1xuICAgICAgICBjd2Q6IHJvb3REaXJcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHN0ZG91dC50cmltKCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG5cbiAgaWYgKCF1c2VHaXRodWJBcGlGYWxsYmFjaykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNCb2R5T2JqID0gKGF3YWl0IGF4aW9zLmdldChgJHtHSVRIVUJfQVBJfS90YWdzYCwge1xuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnVXNlci1BZ2VudCc6IGBBcHBpdW0gJHtBUFBJVU1fVkVSfWBcbiAgICAgIH1cbiAgICB9KSkuZGF0YTtcbiAgICBpZiAoXy5pc0FycmF5KHJlc0JvZHlPYmopKSB7XG4gICAgICBmb3IgKGNvbnN0IHtuYW1lLCBjb21taXR9IG9mIHJlc0JvZHlPYmopIHtcbiAgICAgICAgaWYgKG5hbWUgPT09IGB2JHtBUFBJVU1fVkVSfWAgJiYgY29tbWl0ICYmIGNvbW1pdC5zaGEpIHtcbiAgICAgICAgICByZXR1cm4gY29tbWl0LnNoYTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSBjYXRjaCAoaWduKSB7fVxuICByZXR1cm4gbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0R2l0VGltZXN0YW1wIChjb21taXRTaGEsIHVzZUdpdGh1YkFwaUZhbGxiYWNrID0gZmFsc2UpIHtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhwYXRoLnJlc29sdmUocm9vdERpciwgR0lUX01FVEFfUk9PVCkpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhHSVRfQklOQVJZLCBbJ3Nob3cnLCAnLXMnLCAnLS1mb3JtYXQ9JWNpJywgY29tbWl0U2hhXSwge1xuICAgICAgICBjd2Q6IHJvb3REaXJcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHN0ZG91dC50cmltKCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG5cbiAgaWYgKCF1c2VHaXRodWJBcGlGYWxsYmFjaykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNCb2R5T2JqID0gKGF3YWl0IGF4aW9zLmdldChgJHtHSVRIVUJfQVBJfS9jb21taXRzLyR7Y29tbWl0U2hhfWAsIHtcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ1VzZXItQWdlbnQnOiBgQXBwaXVtICR7QVBQSVVNX1ZFUn1gXG4gICAgICB9XG4gICAgfSkpLmRhdGE7XG4gICAgaWYgKHJlc0JvZHlPYmogJiYgcmVzQm9keU9iai5jb21taXQpIHtcbiAgICAgIGlmIChyZXNCb2R5T2JqLmNvbW1pdC5jb21taXR0ZXIgJiYgcmVzQm9keU9iai5jb21taXQuY29tbWl0dGVyLmRhdGUpIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHlPYmouY29tbWl0LmNvbW1pdHRlci5kYXRlO1xuICAgICAgfVxuICAgICAgaWYgKHJlc0JvZHlPYmouY29tbWl0LmF1dGhvciAmJiByZXNCb2R5T2JqLmNvbW1pdC5hdXRob3IuZGF0ZSkge1xuICAgICAgICByZXR1cm4gcmVzQm9keU9iai5jb21taXQuYXV0aG9yLmRhdGU7XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChpZ24pIHt9XG4gIHJldHVybiBudWxsO1xufVxuXG4vKipcbiAqIEByZXR1cm5zIE11dGFibGUgb2JqZWN0IGNvbnRhaW5pbmcgQXBwaXVtIGJ1aWxkIGluZm9ybWF0aW9uLiBCeSBkZWZhdWx0IGl0XG4gKiBvbmx5IGNvbnRhaW5zIHRoZSBBcHBpdW0gdmVyc2lvbiwgYnV0IGlzIHVwZGF0ZWQgd2l0aCB0aGUgYnVpbGQgdGltZXN0YW1wXG4gKiBhbmQgZ2l0IGNvbW1pdCBoYXNoIGFzeW5jaHJvbm91c2x5IGFzIHNvb24gYXMgYHVwZGF0ZUJ1aWxkSW5mb2AgaXMgY2FsbGVkXG4gKiBhbmQgc3VjY2VlZHMuXG4gKi9cbmZ1bmN0aW9uIGdldEJ1aWxkSW5mbyAoKSB7XG4gIHJldHVybiBCVUlMRF9JTkZPO1xufVxuXG5mdW5jdGlvbiBjaGVja05vZGVPayAoKSB7XG4gIGNvbnN0IHZlcnNpb24gPSBnZXROb2RlVmVyc2lvbigpO1xuICBpZiAoIXNlbXZlci5zYXRpc2ZpZXModmVyc2lvbiwgTUlOX05PREVfVkVSU0lPTikpIHtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgTm9kZSB2ZXJzaW9uIG11c3QgYmUgJHtNSU5fTk9ERV9WRVJTSU9OfS4gQ3VycmVudGx5ICR7dmVyc2lvbi52ZXJzaW9ufWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHdhcm5Ob2RlRGVwcmVjYXRpb25zICgpIHtcbiAgLyoqXG4gICAqIFVuY29tbWVudCB0aGlzIHNlY3Rpb24gdG8gZ2V0IG5vZGUgdmVyc2lvbiBkZXByZWNhdGlvbiB3YXJuaW5nc1xuICAgKiBBbHNvIGFkZCB0ZXN0IGNhc2VzIHRvIGNvbmZpZy1zcGVjcy5qcyB0byBjb3ZlciB0aGUgY2FzZXMgYWRkZWRcbiAgICoqL1xuXG4gIC8vIGNvbnN0IHZlcnNpb24gPSBnZXROb2RlVmVyc2lvbigpO1xuICAvLyBpZiAodmVyc2lvbi5tYWpvciA8IDgpIHtcbiAgLy8gICBsb2dnZXIud2FybihgQXBwaXVtIHN1cHBvcnQgZm9yIHZlcnNpb25zIG9mIG5vZGUgPCAke3ZlcnNpb24ubWFqb3J9IGhhcyBiZWVuIGAgK1xuICAvLyAgICAgICAgICAgICAgICdkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlICcgK1xuICAvLyAgICAgICAgICAgICAgICd1cGdyYWRlIScpO1xuICAvLyB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNob3dDb25maWcgKCkge1xuICBhd2FpdCB1cGRhdGVCdWlsZEluZm8odHJ1ZSk7XG4gIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGdldEJ1aWxkSW5mbygpKSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxufVxuXG5mdW5jdGlvbiBnZXROb25EZWZhdWx0QXJncyAocGFyc2VyLCBhcmdzKSB7XG4gIHJldHVybiBwYXJzZXIucmF3QXJncy5yZWR1Y2UoKGFjYywgWywge2Rlc3QsIGRlZmF1bHQ6IGRlZmF1bHRWYWx1ZX1dKSA9PiB7XG4gICAgaWYgKGFyZ3NbZGVzdF0gJiYgYXJnc1tkZXN0XSAhPT0gZGVmYXVsdFZhbHVlKSB7XG4gICAgICBhY2NbZGVzdF0gPSBhcmdzW2Rlc3RdO1xuICAgIH1cbiAgICByZXR1cm4gYWNjO1xuICB9LCB7fSk7XG59XG5cbmZ1bmN0aW9uIGdldERlcHJlY2F0ZWRBcmdzIChwYXJzZXIsIGFyZ3MpIHtcbiAgLy8gZ28gdGhyb3VnaCB0aGUgc2VydmVyIGNvbW1hbmQgbGluZSBhcmd1bWVudHMgYW5kIGZpZ3VyZVxuICAvLyBvdXQgd2hpY2ggb2YgdGhlIG9uZXMgdXNlZCBhcmUgZGVwcmVjYXRlZFxuICByZXR1cm4gcGFyc2VyLnJhd0FyZ3MucmVkdWNlKChhY2MsIFtbbmFtZV0sIHtkZXN0LCBkZWZhdWx0OiBkZWZhdWx0VmFsdWUsIGFjdGlvbn1dKSA9PiB7XG4gICAgaWYgKCFhcmdzW2Rlc3RdIHx8IGFyZ3NbZGVzdF0gPT09IGRlZmF1bHRWYWx1ZSkge1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9XG5cbiAgICBpZiAoYWN0aW9uPy5kZXByZWNhdGVkX2Zvcikge1xuICAgICAgYWNjW25hbWVdID0gYWN0aW9uLmRlcHJlY2F0ZWRfZm9yO1xuICAgIH0gZWxzZSBpZiAoaXNTdWJDbGFzcyhhY3Rpb24sIFN0b3JlRGVwcmVjYXRlZERlZmF1bHRDYXBhYmlsaXR5QWN0aW9uKSkge1xuICAgICAgYWNjW25hbWVdID0gREVGQVVMVF9DQVBTX0FSRztcbiAgICB9XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xufVxuXG5mdW5jdGlvbiBjaGVja1ZhbGlkUG9ydCAocG9ydCwgcG9ydE5hbWUpIHtcbiAgaWYgKHBvcnQgPiAwICYmIHBvcnQgPCA2NTUzNikgcmV0dXJuIHRydWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgbG9nZ2VyLmVycm9yKGBQb3J0ICcke3BvcnROYW1lfScgbXVzdCBiZSBncmVhdGVyIHRoYW4gMCBhbmQgbGVzcyB0aGFuIDY1NTM2LiBDdXJyZW50bHkgJHtwb3J0fWApO1xuICByZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlU2VydmVyQXJncyAocGFyc2VyLCBhcmdzKSB7XG4gIC8vIGFyZ3VtZW50cyB0aGF0IGNhbm5vdCBib3RoIGJlIHNldFxuICBsZXQgZXhjbHVzaXZlcyA9IFtcbiAgICBbJ25vUmVzZXQnLCAnZnVsbFJlc2V0J10sXG4gICAgWydpcGEnLCAnc2FmYXJpJ10sXG4gICAgWydhcHAnLCAnc2FmYXJpJ10sXG4gICAgWydmb3JjZUlwaG9uZScsICdmb3JjZUlwYWQnXSxcbiAgICBbJ2RldmljZU5hbWUnLCAnZGVmYXVsdERldmljZSddXG4gIF07XG5cbiAgZm9yIChsZXQgZXhTZXQgb2YgZXhjbHVzaXZlcykge1xuICAgIGxldCBudW1Gb3VuZEluQXJncyA9IDA7XG4gICAgZm9yIChsZXQgb3B0IG9mIGV4U2V0KSB7XG4gICAgICBpZiAoXy5oYXMoYXJncywgb3B0KSAmJiBhcmdzW29wdF0pIHtcbiAgICAgICAgbnVtRm91bmRJbkFyZ3MrKztcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG51bUZvdW5kSW5BcmdzID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3UgY2FuJ3QgcGFzcyBpbiBtb3JlIHRoYW4gb25lIGFyZ3VtZW50IGZyb20gdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBzZXQgJHtKU09OLnN0cmluZ2lmeShleFNldCl9LCBzaW5jZSB0aGV5IGFyZSBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgbXV0dWFsbHkgZXhjbHVzaXZlYCk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgdmFsaWRhdGlvbnMgPSB7XG4gICAgcG9ydDogY2hlY2tWYWxpZFBvcnQsXG4gICAgY2FsbGJhY2tQb3J0OiBjaGVja1ZhbGlkUG9ydCxcbiAgICBib290c3RyYXBQb3J0OiBjaGVja1ZhbGlkUG9ydCxcbiAgICBjaHJvbWVkcml2ZXJQb3J0OiBjaGVja1ZhbGlkUG9ydCxcbiAgICByb2JvdFBvcnQ6IGNoZWNrVmFsaWRQb3J0LFxuICAgIGJhY2tlbmRSZXRyaWVzOiAocikgPT4gciA+PSAwLFxuICB9O1xuXG4gIGNvbnN0IG5vbkRlZmF1bHRBcmdzID0gZ2V0Tm9uRGVmYXVsdEFyZ3MocGFyc2VyLCBhcmdzKTtcblxuICBmb3IgKGxldCBbYXJnLCB2YWxpZGF0b3JdIG9mIF8udG9QYWlycyh2YWxpZGF0aW9ucykpIHtcbiAgICBpZiAoXy5oYXMobm9uRGVmYXVsdEFyZ3MsIGFyZykpIHtcbiAgICAgIGlmICghdmFsaWRhdG9yKGFyZ3NbYXJnXSwgYXJnKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJndW1lbnQgZm9yIHBhcmFtICR7YXJnfTogJHthcmdzW2FyZ119YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZhbGlkYXRlVG1wRGlyICh0bXBEaXIpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBta2RpcnAodG1wRGlyKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgV2UgY291bGQgbm90IGVuc3VyZSB0aGF0IHRoZSB0ZW1wIGRpciB5b3Ugc3BlY2lmaWVkIGAgK1xuICAgICAgICAgICAgICAgICAgICBgKCR7dG1wRGlyfSkgZXhpc3RzLiBQbGVhc2UgbWFrZSBzdXJlIGl0J3Mgd3JpdGVhYmxlLmApO1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIGdldEJ1aWxkSW5mbywgdmFsaWRhdGVTZXJ2ZXJBcmdzLCBjaGVja05vZGVPaywgc2hvd0NvbmZpZyxcbiAgd2Fybk5vZGVEZXByZWNhdGlvbnMsIHZhbGlkYXRlVG1wRGlyLCBnZXROb25EZWZhdWx0QXJncywgZ2V0RGVwcmVjYXRlZEFyZ3MsXG4gIGdldEdpdFJldiwgY2hlY2tWYWxpZFBvcnQsIEFQUElVTV9WRVIsIHVwZGF0ZUJ1aWxkSW5mbyxcbn07XG4iXSwiZmlsZSI6ImxpYi9jb25maWcuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
